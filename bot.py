import os
import yt_dlp
import asyncio
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, ContextTypes, filters

TOKEN = os.getenv("BOT_TOKEN")

# ===== Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© =====
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ!\n"
        "Ø£Ù†Ø§ Ø¨ÙˆØª Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„ ğŸ”¥\n"
        "Ø£Ø±Ø³Ù„ Ù„ÙŠ Ø£ÙŠ Ø±Ø§Ø¨Ø· Ù…Ù† Ø§Ù„Ù…Ù†ØµØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© ÙˆØ³Ø£Ø­Ù…Ù‘Ù„Ù‡ Ù„Ùƒ:\n\n"
        "ğŸ“˜ Facebook\nğŸ“¸ Instagram\nğŸµ TikTok\nâ–¶ï¸ YouTube\n\n"
        "ÙƒÙ„ Ù…Ø§ Ø¹Ù„ÙŠÙƒ Ù‡Ùˆ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙ‚Ø· ğŸ’¥"
    )

# ===== Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ =====
def download_video(url: str):
    output_path = "video.mp4"
    ydl_opts = {
        "outtmpl": output_path,
        "format": "best[ext=mp4]/best",
        "quiet": True,
        "noplaylist": True,
    }

    try:
        with yt_dlp.YoutubeDL(ydl_opts) as ydl:
            info = ydl.extract_info(url, download=True)
        return output_path, info.get("title", "ÙÙŠØ¯ÙŠÙˆ Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†")
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„: {e}")
        return None, None

# ===== ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†ØµØ© =====
def detect_platform(url: str):
    if "facebook.com" in url or "fb.watch" in url:
        return "Facebook"
    elif "instagram.com" in url:
        return "Instagram"
    elif "tiktok.com" in url:
        return "TikTok"
    elif "youtube.com" in url or "youtu.be" in url:
        return "YouTube"
    else:
        return None

# ===== Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ =====
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    url = update.message.text.strip()
    platform = detect_platform(url)

    if not platform:
        await update.message.reply_text("âš ï¸ Ø£Ø±Ø³Ù„ Ù„ÙŠ Ø±Ø§Ø¨Ø· Ù…Ù† Facebook Ø£Ùˆ Instagram Ø£Ùˆ TikTok Ø£Ùˆ YouTube ÙÙ‚Ø·.")
        return

    await update.message.reply_text(f"â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† {platform}...")

    video_path, title = await asyncio.to_thread(download_video, url)

    if video_path and os.path.exists(video_path):
        await update.message.reply_video(video=open(video_path, "rb"), caption=f"âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† {platform}\nğŸ¬ {title}")
        os.remove(video_path)
    else:
        await update.message.reply_text("âŒ Ù„Ù… Ø£Ø³ØªØ·Ø¹ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø¹Ø§Ù… Ø£Ùˆ ØµØ§Ù„Ø­.")

# ===== Ø§Ù„ØªØ´ØºÙŠÙ„ =====
def main():
    app = Application.builder().token(TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    print("ğŸš€ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø´Ø§Ù…Ù„ ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†...")
    app.run_polling()

if __name__ == "__main__":
    main()
